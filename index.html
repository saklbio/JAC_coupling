<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Input Data Form</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      .flash {
        background-color: #6aa7f2; 
        transition: background-color 0.5s ease;
      }
    </style>
  </head>
  <body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-lg">
      <h2 class="text-xl font-bold mb-4">INPUT DATA</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <div class="mb-4">
            <label class="block font-medium">Motor Power</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="motorPower"
                tabindex="1"
              />
              <select
                name="motorPowerUnit"
                class="w-20 border border-gray-300 p-2 rounded-r"
              >
                <option value="974">KW</option>
                <option value="716">HP</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">Motor Speed</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="motorSpeed"
                tabindex="2"
              />
              <span class="w-20 border border-gray-300 p-2 rounded-r">RPM</span>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">Fan Speed</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="fanSpeed"
                tabindex="3"
              />
              <span class="w-20 border border-gray-300 p-2 rounded-r">RPM</span>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">Motor Shaft Dia</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="motorShaftDia"
                tabindex="4"
              />
              <select
                name="motorShaftDiaUnit"
                class="w-20 border border-gray-300 p-2 rounded-r"
              >
                <option value="1">mm</option>
                <option value="25.4">inch</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">Gearbox Shaft Dia</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="gearboxShaftDia"
                tabindex="5"
              />
              <select
                name="gearboxShaftDiaUnit"
                class="w-20 border border-gray-300 p-2 rounded-r"
              >
                <option value="1">mm</option>
                <option value="25.4">inch</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">No. of Fan Blades</label>
            <input
              type="number"
              placeholder="Enter value"
              class="w-full border border-gray-300 p-2 rounded inputValues"
              name="numFanBlade"
              tabindex="6"
            />
          </div>
          <div class="mb-4">
            <label class="block font-medium">DBSE</label>
            <div class="flex">
              <input
                type="number"
                placeholder="Enter value"
                class="flex-1 border border-gray-300 p-2 rounded-l inputValues"
                name="DBSE"
                tabindex="7"
              />
              <select
                name="DBSEUnit"
                class="w-20 border border-gray-300 p-2 rounded-r"
              >
                <option value="1">mm</option>
                <option value="25.4">inch</option>
              </select>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-medium">Service Factor</label>
            <input
              type="number"
              placeholder="Enter value"
              class="w-full border border-gray-300 p-2 rounded inputValues"
              name="serviceFactor"
              tabindex="8"
            />
          </div>
        </div>
        <div>
          <div class="mb-4">
            <label class="block font-medium">Customer</label>
            <input
              type="text"
              placeholder=""
              class="w-full border border-gray-300 p-2 rounded"
              name="customer"
              autocomplete="off"
              tabindex="9"
            />
          </div>
          <div class="mb-4">
            <label class="block font-medium">Tel</label>
            <input
              type="tel"
              placeholder=""
              class="w-full border border-gray-300 p-2 rounded"
              name="tel"
              autocomplete="off"
              tabindex="10" 
            />
          </div>
          <div class="mb-4">
            <label class="block font-medium">E-mail</label>
            <input
              type="text"
              placeholder=""
              class="w-full border border-gray-300 p-2 rounded"
              name="mail"
              autocomplete="off"
              tabindex="11"
            />
          </div>
          <div class="mb-4">
            <label class="block font-medium">Project Name</label>
            <input
              type="text"
              placeholder=""
              class="w-full border border-gray-300 p-2 rounded"
              name="projectName"
              autocomplete="off"
              tabindex="12"
            />
          </div>
          <div class="flex justify-center items-center h-48 mb-4">
            <img src="./그림1.png" alt="Placeholder Image">
          </div>
        </div>
      </div>
      <div class="flex justify-center mt-6">
        <button
          id="search-btn"
          class="bg-blue-500 text-white px-10 py-4 rounded hover:bg-blue-600"
        >
          Search
        </button>
      </div>
      <div class="flex justify-center mt-4 mx-auto transform origin-center scale-50">
        <img src="./그림2.jpg" alt="JAC Coupling Logo" />
      </div>
    </div>

    <footer class="bg-gray-200 text-center p-4 mt-8">
      <p class="text-sm sm:text-md mb-2">
        Address : 부산시 사상구 새벽로 69 ( 학장동 720-1 ) (주)중앙 카프링 | 69,
        Saebyeok-ro, Sasang-gu, Busan, Republic of Korea
      </p>
      <p class="text-sm sm:text-md mb-2">
        Tel : 051-317-0822 | Fax : 051-317-0855 | E-mail :
        <a href="mailto:jac@jacoup.co.kr" class="text-blue-500 hover:underline"
          >jac@jacoup.co.kr</a
        >
      </p>
      <p class="text-xs sm:text-sm text-gray-600">
        &copy; 2025 JAC Coupling All rights Reserved.
      </p>
      <a
        href="login.html"
        class="text-gray-300 hover:text-blue-500 text-xs block mt-1"
        style="opacity: 0.3"
        onmouseover="this.style.opacity='1'"
        onmouseout="this.style.opacity='0.3'"
      >
        관리자 로그인
      </a>
    </footer>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        query,
        where,
        setDoc,
        updateDoc,
        deleteDoc,
        doc,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js";
      const firebaseConfig = {
        apiKey: "AIzaSyC9MN1S5ANhPjKxkzWIaVc-yadzsDcrxnA",
        authDomain: "jacoupling.firebaseapp.com",
        projectId: "jacoupling",
        storageBucket: "jacoupling.firebasestorage.app",
        messagingSenderId: "1021071980880",
        appId: "1:1021071980880:web:74038cbcac0c98999bd455",
        measurementId: "G-Q3W7WP39B5",
      };
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const modelNames = [];
      const weightUnit = [];
      const peak_torque = [];
      const deflection_ref = [];
      const DBSE_range = [];
      const maxBore_ref1 = [];
      const maxBore_ref2 = [];
      const suitableModels = [];

      async function init() {
        const selectQuery = query(
          collection(db, "models"),
          where("is_use", "==", true),
          orderBy("priority", "asc")
        );
        const originDocs = await getDocs(selectQuery);
        const docs = [...originDocs.docs].sort((a, b) => a.id.localeCompare(b.id));
        const modelMap = new Map();
        for (let doc of docs) {
          const model = doc.data();
          const result = {};
          modelMap.set(doc.id, {
            weight_unit: model.weight_unit,
            continue_torque: model.continue_torque,
            peak_torque: model.peak_torque,
            deflection_ref: model.deflection_ref,
            DBSE_range: model.DBSE_range,
            maxBore_ref1: model.maxBore_ref1,
            maxBore_ref2: model.maxBore_ref2,
            ref1: model.ref1,
            ref2: model.ref2
          });
        }
        sessionStorage.clear();
        console.log("🚨 모델 로딩 완료:");
        // console.debug("🚨 모델 로딩 완료:", modelMap);
        return modelMap;
      }

      function roundTo(num, digits) {
        const factor = Math.pow(10, digits);
        return Math.round(num * factor) / factor;
      }
      function checkBPF(BPF, index) {
        if (BPF1 <= minus10Nic[index] || BPF1 >= plus5Nic[index]) {
          return true;
        } else {
          return false;
        }
      }
      function validateEmail() {
        const email = document.getElementsByName('mail')[0].value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (emailRegex.test(email)) {
          return true;
        } else {
          alert('올바르지 않은 이메일 형식입니다.');
          return false;
        }
      }
      function validateTel() {
        const phone = document.getElementsByName('tel')[0].value;
        const phoneRegex = /^(01[0-9]-?\d{3,4}-?\d{4}|0\d{1,2}-?\d{3,4}-?\d{4})$/;
        if (phoneRegex.test(phone)) {
          return true;
        } else {
          alert('올바르지 않은 연락처 형식입니다.');
          return false;
        }
      }
      //var
      let weight = [];
      let deflection = [];
      let Nb = [];
      let Nb_75percnet = [];
      let operation_torque = [];
      let BPF1 = 0;
      let BPF2 = 0;
      let BPF3 = 0;
      let minus10Nic = [];
      let plus5Nic = [];
      let result_isOkDBSE = [];
      let result_MSD = [];
      let result_GSD = [];
      let result_isOkTorque = [];
      let result_BPF1_judgment = [];
      let result_BPF2_judgment = [];
      let result_BPF3_judgment = [];
      let result_permit_speed_judgment = [];
      let result = [];
      let diagramValue2 = "";
      let diagramValue3 = "";
      // Search 버튼 클릭 시 빈 input 확인 및 하이라이트 처리
      document.getElementById("search-btn").addEventListener("click", async function () {
        const modelMap = await init(); // key: 모델명, value: 계산용 정보 객체
        suitableModels.length  = 0;
        // [1] 입력값 가져오기
        const input = {};
        document.querySelectorAll(".inputValues").forEach((el) => {
          if (!el.value.trim()) {
            el.classList.add("border-red-500");
            // allFilled = false;
          } else {
            el.classList.remove("border-red-500");
            input[el.name] = parseFloat(el.value);
          }
        });

        if (!Object.keys(input).length) return alert("Please enter all values");

        // 단위 선택 값
        input.motorPower = parseFloat(document.getElementsByName("motorPower")[0].value); // E6
        input.motorPowerUnit = parseFloat(document.getElementsByName("motorPowerUnit")[0].value);
        input.motorSpeed = parseFloat(document.getElementsByName("motorSpeed")[0].value); // E7
        input.fanSpeed = parseFloat(document.getElementsByName("fanSpeed")[0].value);
        input.motorShaftDia = parseFloat(document.getElementsByName("motorShaftDia")[0].value);
        input.motorShaftDiaUnit = parseFloat(document.getElementsByName("motorShaftDiaUnit")[0].value);
        input.gearboxShaftDia = parseFloat(document.getElementsByName("gearboxShaftDia")[0].value);
        input.gearboxShaftDiaUnit = parseFloat(document.getElementsByName("gearboxShaftDiaUnit")[0].value);
        input.numFanBlade = parseFloat(document.getElementsByName("numFanBlade")[0].value);
        input.DBSE = parseFloat(document.getElementsByName("DBSE")[0].value);
        input.DBSEUnit = parseFloat(document.getElementsByName("DBSEUnit")[0].value);
        input.serviceFactor = parseFloat(document.getElementsByName("serviceFactor")[0].value);

        // BPF 계산
        const BPF1 = input.fanSpeed * input.numFanBlade;
        const BPF2 = BPF1 * 2;
        const BPF3 = BPF1 * 3;

        // 최초적합모델 여부
        let is_frist = true;
        let suitableModelCnt = 0;
        

        // [2] modelMap 순회하며 조건 만족 여부 확인
        for (const [modelName, model] of modelMap.entries()) {
          let weight = 0.0015 * model.weight_unit * input.DBSE * 1e-3 * input.DBSEUnit;
          let deflection = ((Math.pow((input.DBSE * input.DBSEUnit) / 1000, 3) * 5 * weight) / (384 * 150e8 * model.deflection_ref)) * 1000;
          let Nb = 946 * Math.sqrt(1 / deflection);
          let operation_torque = Math.ceil(((input.motorPower * input.motorPowerUnit) / input.motorSpeed) * 9.8) * input.serviceFactor;
          
          let conditionPass =
            (input.DBSE * input.DBSEUnit <= model.DBSE_range) &&
            (input.motorShaftDia * input.motorShaftDiaUnit <= model.maxBore_ref2) &&
            (input.gearboxShaftDia * input.gearboxShaftDiaUnit <= model.maxBore_ref2) &&
            (operation_torque <= model.peak_torque) &&
            (BPF1 <= Nb * 0.9 || BPF1 >= Nb * 1.05) &&
            (BPF2 <= Nb * 0.9 || BPF2 >= Nb * 1.05) &&
            (BPF3 <= Nb * 0.9 || BPF3 >= Nb * 1.05) &&
            (input.motorSpeed < Nb * 0.75);

          if(!conditionPass) continue;

          suitableModelCnt++;
          const result = {};
          result.driver               = input.motorShaftDia * input.motorShaftDiaUnit <= model.maxBore_ref1 ? "Standard(N)" : "Oversized(U)";
          result.driven               = input.gearboxShaftDia * input.gearboxShaftDiaUnit <= model.maxBore_ref1 ? "Standard(N)" : "Oversized(U)";
          // result.spacer               = "CFRP";
          result.modelName            = `${modelName}${result.driver == "Standard(N)" ? "N" : "U"}${result.driven == "Standard(N)" ? "N" : "U"}`;
          result.torque               = `${model.continue_torque} Nm = ${Math.ceil((model.continue_torque * 8.8507))} lbf·in`;
          result.RPM                  = input.motorSpeed;
          result.distance             = `${formatIfDecimal(input.DBSE)} ${(input.DBSEUnit) == 1 ? "mm" : "inch"}`;
          result.diagramValue1        = `${formatIfDecimal(input.motorShaftDia)} ${input.motorShaftDiaUnit == 1 ? "mm" : "inch"}`;
          if(input.DBSEUnit !== 1){
            result.diagramValue2        = `${Math.round(formatIfDecimal(model.ref1) / input.DBSEUnit)} inch`;
            result.diagramValue3        = `${Math.round(formatIfDecimal(model.ref2) / input.DBSEUnit)} inch`;
          }else{
            result.diagramValue2        = `${formatIfDecimal(model.ref1)} mm`;
            result.diagramValue3        = `${formatIfDecimal(model.ref2)} mm`;
          }
          // result.diagramValue2        = `${formatIfDecimal(model.ref1)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          // result.diagramValue3        = `${formatIfDecimal(model.ref2)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          result.diagramValue4        = `${formatIfDecimal(input.DBSE)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          result.diagramValue5        = `${formatIfDecimal(input.gearboxShaftDia)} ${input.gearboxShaftDiaUnit == 1 ? "mm" : "inch"}`;
          result.customer             = document.getElementsByName("customer")[0].value;
          result.project              = document.getElementsByName("projectName")[0].value;
          result.motorPowerUnit       = `${input.motorPowerUnit == 974 ? "kW" : "HP"}`;
          result.motorShaftDiaUnit    = `${input.motorShaftDiaUnit == 1 ? "mm" : "inch"}`;
          result.gearboxShaftDiaUnit  = `${input.gearboxShaftDiaUnit == 1 ? "mm" : "inch"}`;
          result.DBSEUnit             = `${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          // result.inputData            = JSON.stringify(input);
          result.is_frist             = is_frist;
          // 세션 저장 및 페이지 이동
          // for (const [key, val] of Object.entries(result)) {
          //   sessionStorage.setItem(key, val);
          // }
          // pushSuitModel(result.modelName,result.diagramValue1,result.diagramValue2,result.diagramValue3,result.diagramValue4,result.diagramValue5,is_frist);
          suitableModels.push(result);
          is_frist = false

          // if (is_frist) {
          //   const result = {};
          //   result.driver               = input.motorShaftDia * input.motorShaftDiaUnit <= model.maxBore_ref1 ? "Standard(N)" : "Oversized(U)";
          //   result.driven               = input.gearboxShaftDia * input.gearboxShaftDiaUnit <= model.maxBore_ref1 ? "Standard(N)" : "Oversized(U)";
          //   result.spacer               = "CFRP";
          //   result.modelName            = `${modelName}${result.driver == "Standard(N)" ? "N" : "U"}${result.driven == "Standard(N)" ? "N" : "U"}`;
          //   result.torque               = `${model.continue_torque} Nm = ${Math.ceil((model.continue_torque * 8.8507))} lbf·in`;
          //   result.RPM                  = input.motorSpeed;
          //   result.distance             = `${formatIfDecimal(input.DBSE)} ${(input.DBSEUnit) == 1 ? "mm" : "inch"}`;
          //   result.diagramValue1        = `${formatIfDecimal(input.motorShaftDia)} ${input.motorShaftDiaUnit == 1 ? "mm" : "inch"}`;
          //   if(input.DBSEUnit !== 1){
          //     result.diagramValue2        = `${Math.round(formatIfDecimal(model.ref1) / input.DBSEUnit)} inch`;
          //     result.diagramValue3        = `${Math.round(formatIfDecimal(model.ref2) / input.DBSEUnit)} inch`;
          //   }else{
          //     result.diagramValue2        = `${formatIfDecimal(model.ref1)} mm`;
          //     result.diagramValue3        = `${formatIfDecimal(model.ref2)} mm`;
          //   }
          //   // result.diagramValue2        = `${formatIfDecimal(model.ref1)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          //   // result.diagramValue3        = `${formatIfDecimal(model.ref2)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          //   result.diagramValue4        = `${formatIfDecimal(input.DBSE)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          //   result.diagramValue5        = `${formatIfDecimal(input.gearboxShaftDia)} ${input.gearboxShaftDiaUnit == 1 ? "mm" : "inch"}`;
          //   result.customer             = document.getElementsByName("customer")[0].value;
          //   result.project              = document.getElementsByName("projectName")[0].value
          //   result.motorPowerUnit       = `${input.motorPowerUnit == 974 ? "kW" : "HP"}`
          //   result.motorShaftDiaUnit    = `${input.motorShaftDiaUnit == 1 ? "mm" : "inch"}`
          //   result.gearboxShaftDiaUnit  = `${input.gearboxShaftDiaUnit == 1 ? "mm" : "inch"}`
          //   result.DBSEUnit             = `${input.DBSEUnit == 1 ? "mm" : "inch"}`
          //   result.inputData            = JSON.stringify(input);
          //   // 세션 저장 및 페이지 이동
          //   for (const [key, val] of Object.entries(result)) {
          //     sessionStorage.setItem(key, val);
          //   }
          //   pushSuitModel(result.modelName,result.diagramValue1,result.diagramValue2,result.diagramValue3,result.diagramValue4,result.diagramValue5,is_frist);

          //   is_frist = false
          // }else{
            
          //   let suitModel = {};
          //   let model_tail_1 = input.motorShaftDia * input.motorShaftDiaUnit <= model.maxBore_ref1 ? "N" : "U";
          //   let model_tail_2 = input.gearboxShaftDia * input.gearboxShaftDiaUnit <= model.maxBore_ref1 ? "N" : "U";
            
          //   let diagramValue1 = `${formatIfDecimal(input.motorShaftDia)} ${input.motorShaftDiaUnit == 1 ? "mm" : "inch"}`;
          //   let diagramValue2, diagramValue3, diagramValue4, diagramValue5;

          //   if(input.DBSEUnit !== 1){
          //     diagramValue2        = `${Math.round(formatIfDecimal(model.ref1) / input.DBSEUnit)} inch`;
          //     diagramValue3        = `${Math.round(formatIfDecimal(model.ref2) / input.DBSEUnit)} inch`;
          //   }else{
          //     diagramValue2        = `${formatIfDecimal(model.ref1)} mm`;
          //     diagramValue3        = `${formatIfDecimal(model.ref2)} mm`;
          //   }
          //   diagramValue4        = `${formatIfDecimal(input.DBSE)} ${input.DBSEUnit == 1 ? "mm" : "inch"}`;
          //   diagramValue5        = `${formatIfDecimal(input.gearboxShaftDia)} ${input.gearboxShaftDiaUnit == 1 ? "mm" : "inch"}`;
            
            
          //   let suitModelName = `${modelName}${model_tail_1}${model_tail_2}`;
          //   // suitableModels.push(" " + `${modelName}${model_tail_1}${model_tail_2}`);
          //   // suitableModels.push(suitModel);
          //   pushSuitModel(suitModelName,diagramValue1,diagramValue2,diagramValue3,diagramValue4,diagramValue5,is_frist);
          // }
        }
        
        sessionStorage.setItem("inputData", JSON.stringify(input));
        sessionStorage.setItem("suitableModels", JSON.stringify(suitableModels));
        sessionStorage.setItem("suitableModelCnt", suitableModelCnt);
        sessionStorage.setItem("customer",  document.getElementsByName("customer")[0].value);
        sessionStorage.setItem("project",   document.getElementsByName("projectName")[0].value);
        sessionStorage.setItem("tel",       document.getElementsByName("tel")[0].value);
        if(validateEmail()){
          sessionStorage.setItem("mail",      document.getElementsByName("mail")[0].value);
        }else{
          document.getElementsByName("mail")[0].focus();
          return;
        }
        if(validateTel()){
          sessionStorage.setItem("tel",      document.getElementsByName("tel")[0].value);
        }else{
          document.getElementsByName("tel")[0].focus();
          return;
        }
        // console.log("======= sessionStorage ===========");
        // for (let i = 0; i < sessionStorage.length; i++) {
        //     const key = sessionStorage.key(i);
        //     const value = sessionStorage.getItem(key);
        //     console.log(`Key: ${key}, Value: ${value}`);
        // }

        if(suitableModelCnt > 0){
          window.location.href = "./result.html";
        }else{
          alert("조건을 만족하는 모델이 없습니다.");
        }
      });

      function formatIfDecimal(num) {
        num = Number(num);
        return Number.isInteger(num) ? num : parseFloat(num.toFixed(2));
      }

      // function pushSuitModel(name, val1, val2, val3, val4, val5, is_frist){
      //   suitableModels.push({
      //     modelName: name,
      //     diagramValue1: val1,
      //     diagramValue2: val2,
      //     diagramValue3: val3,
      //     diagramValue4: val4,
      //     diagramValue5: val5,
      //     is_frist: !!is_frist // falsy 값이면 false 처리 (undefined, null, "", 0, false)
      //   });
      // }

      
      window.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("select").forEach(select => {
          select.setAttribute("data-prev", select.value);
        });
      });
    </script>
  </body>
</html>
