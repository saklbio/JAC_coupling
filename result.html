<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>JAC Coupling Inquiry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
      body {
        font-family: "Roboto", sans-serif;
      }
      
      #suitableModelsValues > span{
        cursor: pointer;
      }

    </style>
  </head>

  <body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6" id="capture-area">
      <div class="relative mx-auto w-fit max-w-3xl text-sm md:text-md font-bold text-blue-500 mb-6">
        <h1 class="text-4xl font-bold text-left text-gray-800 mb-6" id="modelName">modelName</h1>
        <!-- <h4 class="text-sm font-bold text-left text-gray-800 mb-6" id="suitableModels">suitableModels</h4> -->
        <img id="resultImage" src="./resultIMG.png" alt="Coupling Diagram"  />
        
        <!-- 각 텍스트 위치들 -->
        <div class="absolute bg-white" style="top: 70%; left: 2%;">
          <span class="" id="diagramValue1">0</span>
        </div>
        <div class="absolute bg-white" style="top: 53%; left: 18%;">
          <span id="diagramValue2">0</span>
        </div>
        <div class="absolute bg-white" style="top: 30%; left: 48%;">
          <span id="diagramValue3">0</span>
        </div>
        <div class="absolute bg-white" style="top: 87%; left: 50%;">
          <span id="diagramValue4">0</span>
        </div>
        <div class="absolute bg-white" style="top: 64%; left: 92%;">
          <span id="diagramValue5">0</span>
        </div>
        <div class="absolute" style="top: 80%; left: 11%;">
          <span style="color: black;" name="motorSide">Motor Side</span>
        </div>
        <div class="absolute" style="top: 80%; right: 9%;">
          <span style="color: black;" name="gearboxSide">Gearbox Side</span>
        </div>
      </div>
      <div class="grid grid-cols" id="suitableModelsDiv">
        <div>
          <div class="mb-4 ">
            <label class="block font-medium mb-1">Suitable Models</label>
            <div class="flex flex-wrap gap-2 p-4 bg-gray-100 rounded-lg" id="suitableModelsValues">
            </div>
          </div>
        </div>
      </div>
      <!-- 그리드 레이아웃을 반응형으로 변경 -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Driver Hub Type</label>
            <div class="flex">
              <input
                type="text"
                class="w-full border border-gray-300 p-2 rounded inputValues"
                id="driver"
                readonly
                value="test_driver"
              />
              <div id="hidden-driver" class="w-full p-2 hidden imageDiv"></div>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Driven Hub Type</label>
            <div class="flex">
              <input
                type="text"
                class="w-full border border-gray-300 p-2 rounded inputValues"
                id="driven"
                readonly
                value="test_driven"
              />
              <div id="hidden-driven" class="w-full p-2 hidden imageDiv"></div>
            </div>
          </div>
          <div class="mb-4 flex gap-2">
            <div class="w-1/2">
              <label class="block font-semibold mb-1">Spacer Material</label>
              <div class="flex">
                <input
                  type="text"
                  class="w-full border border-gray-300 p-2 rounded inputValues"
                  id="spacer"
                  readonly
                  value="CFRP"
                />
                <div id="hidden-spacer" class="w-full p-2 hidden imageDiv">CFRP</div>
              </div>
            </div>
            <div class="w-1/2">
              <label class="block font-semibold mb-1">Hub Material</label>
              <div class="flex">
                <input
                  type="text"
                  class="w-full border border-gray-300 p-2 rounded inputValues"
                  id="hub-material"
                  readonly
                  value="STS304"
                />
                <div id="hidden-spacer" class="w-full p-2 hidden imageDiv">STS304</div>
              </div>
            </div>
            
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Continuous Torque</label>
            <div class="flex">
              <input
                type="text"
                class="w-full border border-gray-300 p-2 rounded inputValues"
                id="torque"
                readonly
                value="test_torque"
              />
              <div id="hidden-torque" class="w-full p-2 hidden imageDiv"></div>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Operation RPM</label>
            <div class="flex">
              <input
                type="text"
                class="w-full border border-gray-300 p-2 rounded inputValues"
                id="RPM"
                readonly
                value="test_rpm"
              />
              <div id="hidden-RPM" class="w-full p-2 hidden imageDiv"></div>
            </div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Distance Between Shaft Ends</label>
            <div class="flex">
              <input
                type="text"
                class="w-full border border-gray-300 p-2 rounded inputValues"
                id="distance"
                readonly
                value="test_distan"
              />
              <div id="hidden-distance" class="w-full p-2 hidden imageDiv"></div>
            </div>
          </div>
        </div>
        <div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Customer</label>
            <input id="customer" type="text" class="w-full border border-gray-300 rounded p-2 inputValues" readonly value="test_Customer" />
            <div id="hidden-customer" class="w-full p-2 mb-2 hidden imageDiv"></div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Tel</label>
            <input id="tel" type="text" class="w-full border border-gray-300 rounded p-2 inputValues" readonly value="test_Tel" />
            <div id="hidden-project" class="w-full p-2 hidden imageDiv"></div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">E-mail</label>
            <input id="mail" type="text" class="w-full border border-gray-300 rounded p-2 inputValues" readonly value="test_email" />
            <div id="hidden-project" class="w-full p-2 hidden imageDiv"></div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Project Name</label>
            <input id="project" type="text" class="w-full border border-gray-300 rounded p-2 inputValues" readonly value="test_Project" />
            <div id="hidden-project" class="w-full p-2 hidden imageDiv"></div>
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1">Remark</label>
            <textarea id="comment" rows="5" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 inputValues" placeholder="Please write additional comments here..."></textarea>
            <div id="hidden-comment" class="block p-2.5 w-full text-sm hidden imageDiv"></div>
          </div>
          
        </div>
      </div>
      <div class="mt-5 text-center" id="buttons-div">
        <p>당사의 표준 외 사양은 별도로 문의 부탁드립니다.</p>
        <p class="mb-6">For customised type, consult JAC.</p>
        <button id="returnBtn" class="bg-blue-500 text-white px-10 py-4 rounded mb-1" onclick="location.href='./index.html'">Return</button>
        <button id="imgDownBtn" class="bg-yellow-500 text-white px-10 py-4 rounded mb-1" onclick="downloadImage()">Download Image</button>
        <button id="mailBtn" class="bg-green-500 text-white px-10 py-4 rounded mb-1" onclick="sendMail()">Send Mail</button>
      </div>
      <!-- <div class="mt-6 text-center flex"> -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="flex justify-center mt-4 mx-auto transform origin-center scale-x-75 scale-y-50">
          <img src="./그림2.jpg" alt="JAC Coupling Logo" />
        </div>
        <div class="mt-4">
          <p class="font-extrabold text-lg">JAC Coupling Inc</p>
          <p>Office: 69, Saebyeok-ro, Sasang-gu, Busan, 47018, Korea</p>
          <p>Tel: +82-51-317-0822</p>
          <p class="font-extrabold mt-4">Inquiry for Quotation</p>
          <a href="mailto:jac@jacoup.co.kr" class="text-blue-500">jac@jacoup.co.kr</a>
        </div>
      </div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-white border-opacity-75 mb-4"></div>
        <div class="text-white text-xl">Please wait a moment</div>
      </div>
    </div>
    <footer class="bg-gray-200 text-center p-4 mt-8 ">
        <p class="text-sm sm:text-md mb-2">Address : 부산시 사상구 새벽로 69 ( 학장동 720-1 ) (주)중앙 카프링 | 69, Saebyeok-ro, Sasang-gu, Busan, Republic of Korea</p>
        <p class="text-sm sm:text-md mb-2">Tel : 051-317-0822 | Fax : 051-317-0855 | E-mail : <a href="mailto:jac@jacoup.co.kr" class="text-blue-500 hover:underline">jac@jacoup.co.kr</p>
        <p class="text-xs sm:text-sm text-gray-600">&copy; 2025 JAC Coupling All rights Reserved.</p>
    </footer>
  <script>
    let inputJson = null;
    const suitableModels = [];
    let selectModelIndex = 0;
    window.addEventListener("DOMContentLoaded", () => {
      let tempSuitableModels = JSON.parse(sessionStorage.getItem("suitableModels") || "[]");
      let suitableModelCnt = sessionStorage.getItem('suitableModelCnt') || 0;
      inputJson = JSON.parse(sessionStorage.getItem('inputData'));
      document.getElementById('modelName').innerText      = tempSuitableModels[0].modelName;
      document.getElementById('diagramValue1').innerText  = tempSuitableModels[0].diagramValue1;
      document.getElementById('diagramValue2').innerText  = tempSuitableModels[0].diagramValue2;
      document.getElementById('diagramValue3').innerText  = tempSuitableModels[0].diagramValue3;
      document.getElementById('diagramValue4').innerText  = tempSuitableModels[0].diagramValue4;
      document.getElementById('diagramValue5').innerText  = tempSuitableModels[0].diagramValue5;
      document.getElementById('driver').value             = tempSuitableModels[0].driver;
      document.getElementById('driven').value             = tempSuitableModels[0].driven;
      // document.getElementById('spacer').value             = sessionStorage.getItem('spacer') || "";
      document.getElementById('torque').value             = tempSuitableModels[0].torque;
      document.getElementById('RPM').value                = tempSuitableModels[0].RPM;
      document.getElementById('distance').value           = tempSuitableModels[0].distance;
      document.getElementById('customer').value           = sessionStorage.getItem('customer') || "";
      document.getElementById('project').value            = sessionStorage.getItem('project') || "";
      document.getElementById('mail').value               = sessionStorage.getItem('mail') || "";
      document.getElementById('tel').value                = sessionStorage.getItem('tel') || "";

     
      console.debug(suitableModelCnt);
      if(suitableModelCnt > 1){
        // suitableModels = suitableModels.split(",");
        let otherModelNames = "";
        tempSuitableModels.forEach(function(element,index) {
          suitableModels.push(element);
          if(!element.is_frist){
            otherModelNames+=' <span onclick="clickModel('+index+',this)" class="inline-block bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full hover:bg-blue-800 hover:text-blue-100">'+element.modelName+'</span>'
          }else{
            otherModelNames+=' <span onclick="clickModel('+index+',this)" class="selectModel inline-block bg-blue-800 text-blue-100 text-sm font-medium px-3 py-1 rounded-full hover:bg-blue-800 hover:text-blue-100">'+element.modelName+'</span>'
          }
        });
        document.getElementById('suitableModelsValues').innerHTML = otherModelNames;
      }else{
        console.log("hidden");
        document.getElementById('suitableModelsDiv').classList.add("hidden");
      }

    });



    emailjs.init("e-9VInmHucxsBzMVY");
    function getDate(){
      var today = new Date();
      var year = today.getFullYear();
      var month = today.getMonth() + 1;
      var day = today.getDate();
      var formattedMonth = String(month).padStart(2, '0');
      var formattedDay = String(day).padStart(2, '0');
      return year + '-' + formattedMonth + '-' + formattedDay;
    }
    
     async function downloadImage() {
      
      const modelName         = document.getElementsByClassName("selectModel")[0].innerText || "unkownun";
      const captureArea       = document.getElementById('capture-area');
      const buttonsDiv        = document.getElementById('buttons-div');
      const suitableModelsDiv = document.getElementById('suitableModelsDiv');
      const inputValues       = document.querySelectorAll(".inputValues");
      const imageDiv          = document.querySelectorAll(".imageDiv");

      const diagramValue1     = document.getElementById('diagramValue1');
      const diagramValue2     = document.getElementById('diagramValue2');

      const loadingOverlay    = document.getElementById('loading-overlay');
      //스크롤 이동동
      window.scrollTo(0, 0);
      // 로딩창 오픈
      loadingOverlay.classList.remove("hidden");
      // 숨길꺼 숨기기거 정리할꺼 정리
      buttonsDiv.classList.add("hidden");
      diagramValue1.classList.add("mb-2");
      diagramValue2.classList.add("mb-2");
      suitableModelsDiv.classList.add("hidden");
      inputValues.forEach(el => {
        el.classList.add("hidden");
        const hiddenEl = document.querySelector(`#hidden-${el.id}`);
        if (hiddenEl) hiddenEl.textContent = el.value;
      });
      imageDiv.forEach(el => el.classList.remove("hidden"));
      
      // STEP 2: 강제 DOM 렌더링 대기 (로딩 포함)
      await new Promise(resolve => setTimeout(resolve, 500));

      // STEP 3: 캡처 직전에 로딩 숨김 → 캡처 → 바로 다시 표시
      loadingOverlay.classList.add("hidden");
      await new Promise(resolve => setTimeout(resolve, 500)); // 로딩 사라짐 반영 대기
      
      html2canvas(captureArea, {
        useCORS: true,
        backgroundColor: null,
        scale: 2,
        scrollX: 0,
        scrollY: 0,
      }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'JAC_coupling_Result(' + modelName + ')_' + getDate() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();

        // 다시 버튼 보이게
        buttonsDiv.classList.remove("hidden");
        diagramValue1.classList.remove("mb-2");
        diagramValue2.classList.remove("mb-2");
        suitableModelsDiv.classList.add("hidden");
        inputValues.forEach(el => el.classList.remove("hidden"));
        imageDiv.forEach(el => el.classList.add("hidden"));
      });
    }

    function sendMail(){
      const loadingOverlay = document.getElementById('loading-overlay');
      loadingOverlay.classList.remove("hidden");

      const inputJson = JSON.parse(sessionStorage.getItem('inputData'));
      const suitableModelNameAry = [];
      for (let index = 0; index < suitableModels.length; index++) {
        const element = suitableModels[index];
        suitableModelNameAry.push(element.modelName );
      }
      let count = 0;
      // console.log("================ mail info ================");
      // console.log(++count,document.getElementById("customer").value);
      // console.log(++count,document.getElementById("mail").value);
      // console.log(++count,document.getElementById("tel").value);
      // console.log(++count,document.getElementById("project").value);
      // console.log(++count,document.getElementById("modelName").innerText);
      // console.log(++count,suitableModelNameAry.join());
      // console.log(++count,document.getElementById("driver").value);
      // console.log(++count,document.getElementById("driven").value);
      // console.log(++count,document.getElementById("spacer").value);
      // console.log(++count,document.getElementById("hub-material").value);
      // console.log(++count,document.getElementById("torque").value);
      // console.log(++count,document.getElementById("RPM").value);
      // console.log(++count,document.getElementById("distance").value);
      // console.log(++count,document.getElementById("comment").value);
      // console.log(++count,inputJson.motorPower);
      // console.log(++count,sessionStorage.getItem("motorPowerUnit"));
      // console.log(++count,inputJson.motorSpeed);
      // console.log(++count,inputJson.fanSpeed);
      // console.log(++count,inputJson.motorShaftDia);
      // console.log(++count,sessionStorage.getItem("motorShaftDiaUnit"));
      // console.log(++count,inputJson.gearboxShaftDia);
      // console.log(++count,sessionStorage.getItem("gearboxShaftDiaUnit"));
      // console.log(++count,inputJson.numFanBlade);
      // console.log(++count,inputJson.DBSE);
      // console.log(++count,sessionStorage.getItem("DBSEUnit"));
      // console.log(++count,inputJson.serviceFactor);
      // jac@jacoup.co.kr
      emailjs.send("service_10skxr8", "template_lqu8vh8", {
        customer: document.getElementById("customer").value,
        project: document.getElementById("project").value,
        mail: document.getElementById("mail").value,
        tel: document.getElementById("tel").value,
        modelName: document.getElementById("modelName").innerText,
        suitableModels: suitableModelNameAry.join(),
        driverHubType: document.getElementById("driver").value,
        drivenHubType: document.getElementById("driven").value,
        spacerMaterial: document.getElementById("spacer").value,
        continuousTorque: document.getElementById("torque").value,
        rpm: document.getElementById("RPM").value,
        distanceBeteewnShaft: document.getElementById("distance").value,
        comment: document.getElementById("comment").value,
        motorPower: inputJson.motorPower,
        motorPowerUnit: sessionStorage.getItem("motorPowerUnit"),
        motorSpeed: inputJson.motorSpeed,
        fanSpeed: inputJson.fanSpeed,
        motorShaftDia: inputJson.motorShaftDia,
        motorShaftDiaUnit: sessionStorage.getItem("motorShaftDiaUnit"),
        gearboxShaftDia: inputJson.gearboxShaftDia,
        gearboxShaftDiaUnit: sessionStorage.getItem("gearboxShaftDiaUnit"),
        numFanBlade: inputJson.numFanBlade,
        DBSE: inputJson.DBSE,
        DBSEUnit: sessionStorage.getItem("DBSEUnit"),
        serviceFactor: inputJson.serviceFactor
      }).then(function(response) {
        const mailBtn = document.getElementById("mailBtn");
        mailBtn.classList.remove("bg-green-500");
        mailBtn.classList.add("bg-gray-500");
        mailBtn.disabled = true;
        // loadingOverlay.classList.add("hidden");
        alert("The mail was successfully sent.");
      }, function(error) {
        alert("Failed to send mail.");
        console.log( error.text);
      });
      loadingOverlay.classList.add("hidden");
    }

    function clickModel(index,el){
      let selectedModel = document.getElementsByClassName("selectModel")[0]
      selectedModel.classList.remove("selectModel");
      selectedModel.classList.remove("bg-blue-800");
      selectedModel.classList.remove("text-blue-100");
      selectedModel.classList.add("bg-blue-100");
      selectedModel.classList.add("text-blue-800");
      el.classList.remove("bg-blue-100");
      el.classList.remove("text-blue-800");
      el.classList.add("bg-blue-800");
      el.classList.add("text-blue-100");
      el.classList.add("selectModel");
      let selectModel = suitableModels[index];
      document.getElementById('modelName').innerText      = selectModel.modelName;
      document.getElementById('diagramValue1').innerText  = selectModel.diagramValue1;
      document.getElementById('diagramValue2').innerText  = selectModel.diagramValue2;
      document.getElementById('diagramValue3').innerText  = selectModel.diagramValue3;
      document.getElementById('diagramValue4').innerText  = selectModel.diagramValue4;
      document.getElementById('diagramValue5').innerText  = selectModel.diagramValue5;
      document.getElementById('driver').value             = selectModel.driver;
      document.getElementById('driven').value             = selectModel.driven;
      // document.getElementById('spacer').value             = selectModel.spacer;
      document.getElementById('torque').value             = selectModel.torque;
      document.getElementById('RPM').value                = selectModel.RPM;
      document.getElementById('distance').value           = selectModel.distance;
    }

  </script>
  </body>
</html>
